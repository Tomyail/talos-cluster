---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      openclaw:
        pod:
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
        initContainers:
          init-config:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: latest
            command:
              - sh
              - -c
            args:
              - |
                set -e
                mkdir -p /home/node/.openclaw /home/node/.local/bin /home/node/.local/go

                if [ ! -f /home/node/.openclaw/openclaw.json ]; then
                  echo '{"gateway":{"mode":"local","trustedProxies":["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16"]}}' > /home/node/.openclaw/openclaw.json
                fi

                export PATH=/home/node/.local/bin:/home/node/.local/go/bin:$PATH

                # Install gh CLI if not present on PVC
                if [ ! -f /home/node/.local/bin/gh ]; then
                  echo "Installing gh CLI..."
                  cd /tmp
                  curl -fsSL https://github.com/cli/cli/releases/download/v2.61.0/gh_2.61.0_linux_amd64.tar.gz -o gh.tar.gz
                  tar xzf gh.tar.gz
                  cp gh_2.61.0_linux_amd64/bin/gh /home/node/.local/bin/
                  rm -rf gh.tar.gz gh_2.61.0_linux_amd64
                fi

                # Install Go if not present on PVC
                if [ ! -f /home/node/.local/go/bin/go ]; then
                  echo "Installing Go..."
                  cd /tmp
                  curl -fsSL https://golang.google.cn/dl/go1.23.5.linux-amd64.tar.gz -L -o go.tar.gz || curl -fsSL https://studygolang.com/dl/golang/go1.23.5.linux-amd64.tar.gz -L -o go.tar.gz
                  tar xzf go.tar.gz
                  mv go /home/node/.local/
                  rm -rf go.tar.gz
                fi

                # Install Homebrew if not present on PVC
                if [ ! -f /home/node/.local/homebrew/bin/brew ]; then
                  echo "Installing Homebrew..."
                  export HOMEBREW_PREFIX=/home/node/.local/homebrew
                  export HOMEBREW_CELLAR=/home/node/.local/homebrew/Cellar
                  export HOMEBREW_REPOSITORY=/home/node/.local/homebrew
                  mkdir -p $HOMEBREW_PREFIX
                  cd /tmp
                  git clone --depth 1 https://github.com/Homebrew/brew $HOMEBREW_PREFIX
                fi

                # Check if pip is available
                set +e
                if command -v pip3 >/dev/null 2>&1 || command -v pip >/dev/null 2>&1 || python3 -m pip --version >/dev/null 2>&1; then
                  echo "pip is available"
                else
                  echo "Installing pip..."
                  cd /tmp
                  curl -fsSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
                  python3 get-pip.py --user --no-warn-script-location --break-system-packages || \
                  python3 get-pip.py --user --no-warn-script-location || \
                  echo "pip install skipped (use python3 -m pip instead)"
                  rm -f get-pip.py
                fi
                set -e
                echo "Init container completed successfully"
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000

        containers:
          app:
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            env:
              HOME: /home/node
              HOMEBREW_CELLAR: /home/node/.local/homebrew/Cellar
              HOMEBREW_PREFIX: /home/node/.local/homebrew
              HOMEBREW_REPOSITORY: /home/node/.local/homebrew
              GOPATH: /home/node/go
              npm_config_prefix: /home/node/.npm-global
              PIP_BREAK_SYSTEM_PACKAGES: "1"
              PATH: /home/node/.local/bin:/home/node/.local/go/bin:/home/node/.local/homebrew/bin:/home/node/.npm-global/bin:/root/.bun/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
            envFrom:
              - secretRef:
                  name: openclaw-secret
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: latest
            command:
              - node
            args:
              - dist/index.js
              - gateway
              - --bind
              - lan
              - --port
              - "18789"
            resources:
              requests:
                cpu: 10m
                memory: 512Mi
              limits:
                memory: 2Gi
    persistence:
      config:
        existingClaim: openclaw
        globalMounts:
          - path: /home/node
      tmp:
        type: emptyDir
        globalMounts:
          - path: /tmp
    service:
      app:
        controller: openclaw
        ports:
          http:
            port: 18789
    route:
      app:
        hostnames: ["{{ .Release.Name }}.${SECRET_DOMAIN}"]
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        rules:
          - backendRefs:
              - identifier: app
                port: 18789
