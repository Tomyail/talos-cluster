---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      openclaw:
        pod:
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
        initContainers:
          init-config:
            image:
              repository: busybox
              tag: latest
            command:
              - sh
              - -c
            args:
              - |
                mkdir -p /home/node/.openclaw
                if [ ! -f /home/node/.openclaw/openclaw.json ]; then
                  echo '{"gateway":{"mode":"local","trustedProxies":["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16"]}}' > /home/node/.openclaw/openclaw.json
                fi
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000

        containers:
          app:
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            env:
              HOME: /home/node
              npm_config_prefix: /home/node/.npm-global
              PATH: /home/node/.npm-global/bin:/root/.bun/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
            envFrom:
              - secretRef:
                  name: openclaw-secret
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: latest
            command:
              - node
            args:
              - dist/index.js
              - gateway
              - --bind
              - lan
              - --port
              - "18789"
            resources:
              requests:
                cpu: 10m
                memory: 512Mi
              limits:
                memory: 2Gi
    persistence:
      config:
        existingClaim: openclaw
        globalMounts:
          - path: /home/node
      tmp:
        type: emptyDir
        globalMounts:
          - path: /tmp
    service:
      app:
        controller: openclaw
        ports:
          http:
            port: 18789
    route:
      app:
        hostnames: ["{{ .Release.Name }}.${SECRET_DOMAIN}"]
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        rules:
          - backendRefs:
              - identifier: app
                port: 18789
